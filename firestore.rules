rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // =================================
    // Helper Functions (सहायक फ़ंक्शन)
    // =================================

    // जाँचता है कि उपयोगकर्ता लॉग इन है या नहीं
    function isAuth() {
      return request.auth != null;
    }

    // जाँचता है कि उपयोगकर्ता अपने ही दस्तावेज़ को एक्सेस कर रहा है
    function isOwner(userId) {
      return isAuth() && request.auth.uid == userId;
    }

    // जाँचता है कि लॉग-इन उपयोगकर्ता एक एडमिन है या नहीं
    function isAdmin() {
      // यह Firestore से उपयोगकर्ता की भूमिका की जानकारी लेता है
      return isAuth() && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.roles.admin is map;
    }
    
    // उपयोगकर्ता की डिलीवरी आईडी प्राप्त करता है (सुरक्षित रूप से)
    function getDeliveryId() {
        // यह पहले जाँचता है कि delivery भूमिका मौजूद है या नहीं, फिर ID लौटाता है
        return get(/databases/$(database)/documents/users/$(request.auth.uid)).data.roles.get('delivery', {}).get('deliveryId', null);
    }


    // =================================
    // Rules for the 'users' collection
    // =================================
    match /users/{userId} {
      // पढ़ने का नियम (READ):
      // एक एडमिन किसी भी उपयोगकर्ता का दस्तावेज़ पढ़ सकता है।
      // एक उपयोगकर्ता केवल अपना ही दस्तावेज़ पढ़ सकता है।
      allow read: if isOwner(userId) || isAdmin();

      // बनाने का नियम (CREATE):
      // कोई भी लॉग-इन उपयोगकर्ता अपना प्रोफ़ाइल बना सकता है।
      allow create: if isAuth();

      // अपडेट करने का नियम (UPDATE):
      // एक उपयोगकर्ता अपनी प्रोफ़ाइल तभी अपडेट कर सकता है जब वह अपनी भूमिका (roles) को न बदले।
      // केवल एक एडमिन ही किसी भी उपयोगकर्ता की भूमिकाओं को अपडेट कर सकता है।
      allow update: if (isOwner(userId) && request.resource.data.roles == resource.data.roles) || isAdmin();

      // डिलीट करने का नियम (DELETE):
      // एक उपयोगकर्ता केवल अपना ही प्रोफ़ाइल डिलीट कर सकता है।
      allow delete: if isOwner(userId);
    }
    
    // =================================
    // Rules for the 'orders' collection
    // =================================
    match /orders/{orderId} {
      // पढ़ने का नियम (READ):
      // ग्राहक अपना ऑर्डर देख सकता है,
      // डिलीवरी बॉय उसे सौंपा गया ऑर्डर देख सकता है,
      // और एडमिन कोई भी ऑर्डर देख सकता है।
      allow read: if (isAuth() && resource.data.customerId == request.auth.uid) || 
                   (isAuth() && resource.data.assignedTo == getDeliveryId()) ||
                   isAdmin();
                   
      // बनाने का नियम (CREATE):
      // केवल प्रमाणित उपयोगकर्ता (ग्राहक) और एडमिन ही ऑर्डर बना सकते हैं।
      allow create: if isAuth();

      // अपडेट करने का नियम (UPDATE):
      // केवल एडमिन ही ऑर्डर को अपडेट कर सकता है (जैसे डिलीवरी बॉय असाइन करना)।
      allow update: if isAdmin();

      // डिलीट करने का नियम (DELETE):
      // केवल एडमिन ही ऑर्डर को डिलीट कर सकता है।
      allow delete: if isAdmin();
    }
  }
}
